# OTIMIZAÇÃO STARNEW INFORMÁTICA - Configuração Nginx
# Configuração otimizada para máxima performance e cache
# Salvar como /etc/nginx/sites-available/starnew.com.br

# OTIMIZAÇÃO: Configurações globais de performance
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # OTIMIZAÇÃO: Configurações básicas de performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    types_hash_max_size 2048;
    server_tokens off;
    
    # OTIMIZAÇÃO: Configurações de buffer
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;

    # Redirecionar HTTP para HTTPS
    server {
        listen 80;
        server_name starnew.com.br www.starnew.com.br;
        return 301 https://$server_name$request_uri;
    }

    # Configuração HTTPS Principal
    server {
        listen 443 ssl http2;
        server_name starnew.com.br www.starnew.com.br;
        
        # Certificados SSL
        ssl_certificate /etc/letsencrypt/live/starnew.com.br/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/starnew.com.br/privkey.pem;
        
        # OTIMIZAÇÃO: Configurações SSL modernas e otimizadas
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        
        # OTIMIZAÇÃO: OCSP Stapling
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=300s;
        resolver_timeout 5s;
        
        # OTIMIZAÇÃO: Headers de Segurança
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options DENY always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        
        # OTIMIZAÇÃO: Content Security Policy
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://formspree.io; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://formspree.io; frame-src https://www.google.com;" always;
        
        # OTIMIZAÇÃO: Compressão Gzip avançada
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_comp_level 6;
        gzip_proxied any;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/xml+rss
            application/json
            application/xml
            image/svg+xml
            font/woff
            font/woff2
            application/font-woff
            application/font-woff2;
        
        # OTIMIZAÇÃO: Configuração de diretório e index
        root /var/www/starnew.com.br;
        index index.html;
        
        # OTIMIZAÇÃO: Logs
        access_log /var/log/nginx/starnew.com.br.access.log;
        error_log /var/log/nginx/starnew.com.br.error.log;
        
        # OTIMIZAÇÃO: Cache agressivo para recursos estáticos
        location ~* \.(css|js|png|jpg|jpeg|gif|webp|avif|ico|svg|woff|woff2|ttf|otf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
            
            # Headers de segurança para recursos estáticos
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            
            # Otimizações específicas para WebP
            location ~* \.webp$ {
                add_header Vary Accept;
                add_header Content-Type image/webp;
            }
            
            # Desabilitar logs para recursos estáticos
            access_log off;
            
            # Configurações de buffer para arquivos grandes
            sendfile on;
            tcp_nopush on;
            tcp_nodelay on;
        }
        
        # OTIMIZAÇÃO: Cache para HTML com validação
        location ~* \.(html|htm)$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
            add_header Vary Accept-Encoding;
            
            # Headers de segurança
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            add_header X-XSS-Protection "1; mode=block";
        }
        
        # OTIMIZAÇÃO: Cache para documentos
        location ~* \.(pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header Vary Accept-Encoding;
        }
        
        # OTIMIZAÇÃO: Configuração principal com cache
        location / {
            try_files $uri $uri/ =404;
            
            # Headers adicionais para performance
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            add_header X-XSS-Protection "1; mode=block";
            
            # OTIMIZAÇÃO: Preload de recursos críticos
            add_header Link "</images/logo.webp>; rel=preload; as=image; type=image/webp" always;
            add_header Link "<https://fonts.googleapis.com>; rel=preconnect" always;
            add_header Link "<https://fonts.gstatic.com>; rel=preconnect; crossorigin" always;
        }
        
        # OTIMIZAÇÃO: Configuração específica para imagens
        location /images/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary "Accept, Accept-Encoding";
            
            # Suporte a WebP automático
            location ~* \.(png|jpg|jpeg)$ {
                add_header Vary Accept;
                try_files $uri$webp_suffix $uri =404;
            }
            
            # Desabilitar logs para imagens
            access_log off;
        }
        
        # OTIMIZAÇÃO: Configuração para fontes
        location /fonts/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Access-Control-Allow-Origin "*";
            add_header Vary Accept-Encoding;
            access_log off;
        }
        
        # OTIMIZAÇÃO: Proteção contra acesso a arquivos sensíveis
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        location ~ \.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|old)$ {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        # OTIMIZAÇÃO: Configuração para formulários (Formspree)
        location /formspree/ {
            proxy_pass https://formspree.io;
            proxy_set_header Host formspree.io;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cache para respostas de formulário
            proxy_cache_valid 200 1m;
            proxy_cache_valid 404 1m;
        }
        
        # OTIMIZAÇÃO: Configuração para Google Maps
        location /maps/ {
            proxy_pass https://www.google.com/maps/;
            proxy_set_header Host www.google.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cache para mapas
            proxy_cache_valid 200 1h;
        }
        
        # OTIMIZAÇÃO: Configuração para robots.txt e sitemap.xml
        location = /robots.txt {
            expires 1d;
            add_header Cache-Control "public";
            access_log off;
        }
        
        location = /sitemap.xml {
            expires 1d;
            add_header Cache-Control "public";
            access_log off;
        }
        
        # OTIMIZAÇÃO: Configuração para favicon
        location = /favicon.ico {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
            log_not_found off;
        }
        
        # OTIMIZAÇÃO: Configuração para manifest e service worker
        location = /manifest.json {
            expires 1w;
            add_header Cache-Control "public";
        }
        
        location = /sw.js {
            expires 0;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # OTIMIZAÇÃO: Configuração para subdomínio www (redirecionamento)
    server {
        listen 443 ssl http2;
        server_name www.starnew.com.br;
        
        # Mesmas configurações SSL
        ssl_certificate /etc/letsencrypt/live/starnew.com.br/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/starnew.com.br/privkey.pem;
        
        # Configurações SSL básicas
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # Redirecionar www para domínio principal
        return 301 https://starnew.com.br$request_uri;
    }
    
    # OTIMIZAÇÃO: Configurações de mapeamento de tipos MIME
    map $http_accept $webp_suffix {
        default "";
        "~*webp" ".webp";
    }
    
    # OTIMIZAÇÃO: Rate limiting para proteção
    limit_req_zone $binary_remote_addr zone=login:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
    
    # OTIMIZAÇÃO: Configuração de cache de proxy
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g 
                     inactive=60m use_temp_path=off;
}

